# """
# Django settings for myproject project.

# Generated by 'django-admin startproject' using Django 2.2.4.

# For more information on this file, see
# https://docs.djangoproject.com/en/2.2/topics/settings/

# For the full list of settings and their values, see
# https://docs.djangoproject.com/en/2.2/ref/settings/
# """

# import os

# # Build paths inside the project like this: os.path.join(BASE_DIR, ...)
# BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# # Quick-start development settings - unsuitable for production
# # See https://docs.djangoproject.com/en/2.2/howto/deployment/checklist/

# # SECURITY WARNING: keep the secret key used in production secret!
# SECRET_KEY = 'u+acmc%%_vtsdlecltxttagkxp%1fpla+yi6rt2v+p+94w_$o5'

# # SECURITY WARNING: don't run with debug turned on in production!
# DEBUG = True

# ALLOWED_HOSTS = ['*',]


# # Application definition

# INSTALLED_APPS = [
#     "admin_interface",
#     "colorfield",
#     'django.contrib.admin',
#     'django.contrib.auth',
#     'django.contrib.contenttypes',
#     'django.contrib.sessions',
#     'django.contrib.messages',
#     'django.contrib.staticfiles',
#     'home',          # é¦–é¡µ
#     'articles',      # æ–‡ç« 
#     'links',         # å‹é“¾
#     'message',      # ç•™è¨€æ¿
#     'diary',         # ç”Ÿæ´»æ—¥è®°
#     'about',         # å…³äº
#     'search',        #æœç´¢
# ]

# MIDDLEWARE = [
#     'django.middleware.security.SecurityMiddleware',
#     'django.contrib.sessions.middleware.SessionMiddleware',
#     'django.middleware.common.CommonMiddleware',
#     'django.middleware.csrf.CsrfViewMiddleware',
#     'django.contrib.auth.middleware.AuthenticationMiddleware',
#     'django.contrib.messages.middleware.MessageMiddleware',
#     'django.middleware.clickjacking.XFrameOptionsMiddleware',
# ]

# ROOT_URLCONF = 'myproject.urls'

# TEMPLATES = [
#     {
#         'BACKEND': 'django.template.backends.django.DjangoTemplates',
#         'DIRS': [
#             os.path.join(BASE_DIR, 'templates')
#         ],
#         'APP_DIRS': True,
#         'OPTIONS': {
#             'context_processors': [
#                 'django.template.context_processors.debug',
#                 'django.template.context_processors.request',
#                 'django.contrib.auth.context_processors.auth',
#                 'django.contrib.messages.context_processors.messages',
#             ],
#         },
#     },
# ]

# WSGI_APPLICATION = 'myproject.wsgi.application'


# # Database
# # https://docs.djangoproject.com/en/2.2/ref/settings/#databases

# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.sqlite3',
#         'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
#     }
# }


# # Password validation
# # https://docs.djangoproject.com/en/2.2/ref/settings/#auth-password-validators

# AUTH_PASSWORD_VALIDATORS = [
#     {
#         'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
#     },
#     {
#         'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
#     },
#     {
#         'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
#     },
#     {
#         'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
#     },
# ]


# # Internationalization
# # https://docs.djangoproject.com/en/2.2/topics/i18n/

# LANGUAGE_CODE = 'zh-hans'

# TIME_ZONE = 'Asia/Shanghai'

# USE_I18N = True

# USE_L10N = True

# USE_TZ = False


# # Static files (CSS, JavaScript, Images)
# # https://docs.djangoproject.com/en/2.2/howto/static-files/

# STATIC_URL = '/static/'
# STATICFILES_DIRS = [
#     os.path.join(BASE_DIR, 'static'),
# ]

# X_FRAME_OPTIONS = "SAMEORIGIN"  # å…è®¸ä½¿ç”¨ iframe
# SILENCED_SYSTEM_CHECKS = ["security.W019"]  # ç¦ç”¨å¸§æ£€æŸ¥è­¦å‘Š


"""
Django settings for myproject project.
Optimized for Django 3.2.18 and admin_interface
"""

import os
from django.utils import timezone
from datetime import datetime

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'u+acmc%%_vtsdlecltxttagkxp%1fpla+yi6rt2v+p+94w_$o5'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']


# Application definition

INSTALLED_APPS = [
    # django-admin-interface å¿…é¡»æ”¾åœ¨ admin ä¹‹å‰
    "admin_interface",
    "colorfield",
    
    # Django æ ¸å¿ƒåº”ç”¨
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # è‡ªå®šä¹‰åº”ç”¨
    'home',          # é¦–é¡µ
    'articles',      # æ–‡ç« 
    'links',         # å‹é“¾
    'message',       # ç•™è¨€æ¿
    'diary',         # ç”Ÿæ´»æ—¥è®°
    'about',         # å…³äº
    'search',        # æœç´¢
    'core'           #ä¸Šä¸‹æ–‡å¤„ç†
]

# django-admin-interface ä¸»é¢˜é…ç½®
X_FRAME_OPTIONS = "SAMEORIGIN"
SILENCED_SYSTEM_CHECKS = ["security.W019"]  # ç¦ç”¨å¸§æ£€æŸ¥è­¦å‘Š

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'myproject.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [
            os.path.join(BASE_DIR, 'templates'),
            # æ·»åŠ  admin_interface æ¨¡æ¿è·¯å¾„
            os.path.join(BASE_DIR, 'templates/admin'),
        ],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'core.context_processors.backend_stats',
                
                # admin_interface æ‰€éœ€
                'django.template.context_processors.i18n',
                'django.template.context_processors.media',
                'django.template.context_processors.static',
                'django.template.context_processors.tz',
            ],
        },
    },
]

WSGI_APPLICATION = 'myproject.wsgi.application'


# Database
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False

# æ—¥æœŸæ—¶é—´æ ¼å¼
DATETIME_FORMAT = 'Y-m-d H:i:s'
DATE_FORMAT = 'Y-m-d'


# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')  # ç”Ÿäº§ç¯å¢ƒæ”¶é›†é™æ€æ–‡ä»¶
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]

# åª’ä½“æ–‡ä»¶é…ç½®
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

# é‚®ä»¶é…ç½®ï¼ˆç¤ºä¾‹ï¼‰
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.example.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'no-reply@example.com'
EMAIL_HOST_PASSWORD = 'password'


# ç¼“å­˜é…ç½®
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'unique-snowflake',
    }
}


# æ—¥å¿—é…ç½®
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs/django.log'),
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'WARNING',
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


# =============================================================
# åå°ç®¡ç†ç³»ç»Ÿå®šåˆ¶é…ç½® - django-admin-interface
# =============================================================

# åå°ç•Œé¢é…ç½®
ADMIN_SITE_HEADER = "åšå®¢ç®¡ç†ç³»ç»Ÿ"
ADMIN_SITE_TITLE = "åšå®¢ç®¡ç†åå°"
ADMIN_INDEX_TITLE = "ç³»ç»Ÿæ§åˆ¶å°"
ADMIN_SITE_URL = '/admin/'

# è‡ªå®šä¹‰èœå•ç»“æ„ï¼ˆéåˆ†ç»„å½¢å¼ï¼‰
ADMIN_MENU_STRUCTURE = [
    {
        "title": "ä»ªè¡¨ç›˜",
        "icon": "fas fa-tachometer-alt",
        "url": "/admin/",
    },
    {
        "title": "ä¸»é¢˜ç®¡ç†",
        "icon": "fas fa-palette",
        "models": [
            {"model": "admin_interface.Theme", "name": "ä¸»é¢˜è®¾ç½®"},
        ]
    },
    {
        "title": "ç”¨æˆ·ç®¡ç†",
        "icon": "fas fa-users",
        "models": [
            {"model": "auth.User", "name": "æ‰€æœ‰ç”¨æˆ·"},
            {"model": "auth.Group", "name": "è§’è‰²ç»„"},
        ]
    },
    {
        "title": "å†…å®¹ç®¡ç†",
        "icon": "fas fa-newspaper",
        "models": [
            {"model": "articles.Article", "name": "æ–‡ç« å†…å®¹"},
            {"model": "diary.Diary", "name": "ç”Ÿæ´»æ—¥è®°"},
        ]
    },
    {
        "title": "ç³»ç»Ÿç®¡ç†",
        "icon": "fas fa-cog",
        "models": [
            {"model": "sites.Site", "name": "ç«™ç‚¹é…ç½®"},
            {"model": "links.Link", "name": "å‹æƒ…é“¾æ¥"},
        ]
    },
]

# è‡ªå®šä¹‰ä¸»é¢˜é…ç½®
ADMIN_INTERFACE_THEME = {
    "name": "åšå®¢ç®¡ç†ç³»ç»Ÿä¸»é¢˜",
    "title": "åšå®¢ç®¡ç†ç³»ç»Ÿ",
    
    # é¢œè‰²æ–¹æ¡ˆï¼ˆæ·±è“è‰²è°ƒï¼‰
    "css_header_background_color": "#1a4f77",  # æ·±è“è‰²é¡¶éƒ¨æ 
    "css_header_text_color": "#ffffff",        # ç™½è‰²æ–‡å­—
    "css_module_background_color": "#2c6dbd",   # è“è‰²æ¨¡å—å¤´
    "css_module_text_color": "#ffffff",        # ç™½è‰²æ–‡å­—
    "css_body_background_color": "#f8f9fa",     # æµ…ç°å†…å®¹èƒŒæ™¯
    "css_sidebar_background_color": "#1a4f77",  # æ·±è“ä¾§è¾¹æ 
    "css_sidebar_text_color": "#e0e0e0",       # æµ…ç°æ–‡å­—
    "css_sidebar_link_color": "#e0e0e0",        # æµ…ç°é“¾æ¥
    "css_sidebar_link_hover_color": "#ffffff",  # ç™½è‰²æ‚¬åœ
    
    # ç™»å½•é¡µå®šåˆ¶
    "login_logo": "img/admin-logo.png",        # åå°LOGO
    "login_background": "img/login-bg.jpg",   # ç™»å½•é¡µèƒŒæ™¯
    "login_box_color": "#ffffff",              # ç™»å½•æ¡†ç™½è‰²èƒŒæ™¯
    "login_button_color": "#2c6dbd",           # ç™»å½•æŒ‰é’®è“è‰²
    
    # å¸ƒå±€é€‰é¡¹
    "sidebar_width": "280px",                  # åŠ å®½ä¾§è¾¹æ 
    "sidebar_menu_style": "accordion",         # æŠ˜å èœå•
    "recent_actions_visible": True,           # æ˜¾ç¤ºæœ€è¿‘åŠ¨ä½œ
    "list_filter_dropdown": True,              # ä¸‹æ‹‰ç­›é€‰å™¨
    "recent_actions_limit": 10,                # æœ€è¿‘åŠ¨ä½œæ•°é‡
    
    # åŠŸèƒ½å¢å¼º
    "list_filter_highlight": True,             # é«˜äº®ç­›é€‰å™¨
    "related_modal_active": True,              # å¯ç”¨æ¨¡æ€æ¡†
    "related_modal_background_color": "rgba(44, 109, 189, 0.7)", 
    "related_modal_rounded_corners": True,
}

# é‡å†™é»˜è®¤çš„èœå•ç”Ÿæˆ
def get_admin_menu_with_custom_structure(app_list, request):
    # ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„è‡ªå®šä¹‰èœå•ç»“æ„
    return ADMIN_MENU_STRUCTURE

# åº”ç”¨è‡ªå®šä¹‰èœå•
from django.contrib import admin
admin.AdminSite.get_menu = get_admin_menu_with_custom_structure


# =============================================================
# ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ï¼ˆå½“DEBUGä¸ºFalseæ—¶å¯ç”¨ï¼‰
# =============================================================
if not DEBUG:
    # å®‰å…¨ç›¸å…³è®¾ç½®
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_SSL_REDIRECT = True
    SECURE_HSTS_SECONDS = 31536000  # 1 year
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    
    # é™æ€æ–‡ä»¶ç”±Nginxç›´æ¥æœåŠ¡
    STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.ManifestStaticFilesStorage'
    
    # æ—¥å¿—é…ç½®ä¼˜åŒ–
    LOGGING['handlers']['file']['class'] = 'logging.handlers.RotatingFileHandler'
    LOGGING['handlers']['file']['maxBytes'] = 1024 * 1024 * 5  # 5 MB
    LOGGING['handlers']['file']['backupCount'] = 5
    
    # ç¼“å­˜é…ç½®ï¼ˆä½¿ç”¨Redisï¼‰
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': 'redis://127.0.0.1:6379/1',
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            }
        }
    }
    
    # ç¦ç”¨ç®¡ç†å‘˜ç•Œé¢ä¸­çš„ DEBUG åŠŸèƒ½
    ADMIN_INTERFACE_THEME["env"] = "production"


# é¡¹ç›®å¯åŠ¨æ—¶æ‰“å°é…ç½®ä¿¡æ¯
if __name__ != "__main__":
    startup_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # è·å– Django ç‰ˆæœ¬
    try:
        import django
        django_version = django.__version__
    except:
        django_version = "3.2.18"
    
    # å®‰å…¨è·å–ä¸»é¢˜åç§°
    try:
        theme_name = ADMIN_INTERFACE_THEME.get('name', 'é»˜è®¤ä¸»é¢˜')
    except:
        theme_name = 'æœªçŸ¥ä¸»é¢˜'
    
    print(f"\n{'='*60}")
    print(f"  ğŸš€ åšå®¢ç®¡ç†ç³»ç»Ÿå·²å¯åŠ¨ (Django {django_version})")
    print(f"  â° å¯åŠ¨æ—¶é—´: {startup_time}")
    print(f"  ğŸŒ åå°åœ°å€: http://localhost:8000/admin/")
    print(f"  ğŸ¨ å½“å‰ä¸»é¢˜: {theme_name}")
    print(f"  ğŸš€ åšä¸»ä¸»ç«™åœ°å€ä¸º: www.chencuo.top")
    print(f"{'='*60}\n")